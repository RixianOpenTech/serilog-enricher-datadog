trigger: [ "*" ]

pool:
  name: Ubuntu 16.04

variables:
  buildConfiguration: 'Release'
  system.prefergit: true

steps:
- checkout: self  # self represents the repo where the initial Pipelines YAML file was found
  persistCredentials: true  # set to 'true' to leave the OAuth token in the Git config after the initial fetch. Required for git commands.

- task: gittools.gitversion.gitversion-task.GitVersion@4
  displayName: GitVersion

- task: DotNetCoreInstaller@0
  displayName: 'Install .NET Core SDK'
  inputs:
    version: '2.2.204'

- script: dotnet restore
  displayName: 'Restore'

- script: dotnet build --configuration $(buildConfiguration)
  displayName: 'Build'

- task: DotNetCoreCLI@2
  displayName: 'Test'
  inputs:
    command: test
    projects: '**/*Tests/*.csproj'
    arguments: '--configuration $(buildConfiguration)'

- task: DotNetCoreCLI@2
  displayName: Pack
  inputs:
    command: custom
    projects: '**\src\**\*.csproj'
    custom: pack
    arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory) /p:SourceRevisionId=$(GitVersion.FullBuildMetadata)  /p:PackageVersion=$(GitVersion.NugetVersion) --verbosity Detailed'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'